<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Book Explorer Dashboard</title>
    <style>
        :root { --primary: #3498db; --amazon: #FF9900; --bg: #f8f9fa; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); height: 100vh; overflow: hidden; }
        
        /* The "Spread" Layout Container */
        .app-container {
            display: grid;
            grid-template-columns: 350px 1fr 400px; /* 3 Columns */
            height: 100vh;
        }

        /* Left Column: Search */
        .sidebar-left {
            background: white; border-right: 1px solid #ddd; padding: 20px;
            overflow-y: auto; display: flex; flex-direction: column;
        }

        /* Center Column: Book Details */
        .main-content {
            padding: 40px; overflow-y: auto; background: white;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }

        /* Right Column: Forum */
        .sidebar-right {
            background: #fff; border-left: 1px solid #ddd; padding: 20px;
            overflow-y: auto; display: flex; flex-direction: column;
        }

        /* UI Components */
        .search-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box;}
        
        .book-result { 
            display: flex; gap: 10px; padding: 10px; margin-bottom: 10px; 
            cursor: pointer; border-radius: 8px; transition: 0.2s; border: 1px solid transparent;
        }
        .book-result:hover { background: #f0f7ff; border-color: var(--primary); }
        .book-result img { width: 50px; height: 75px; border-radius: 4px; object-fit: cover; }

        .amazon-btn {
            background: var(--amazon); color: black; padding: 15px 30px;
            text-decoration: none; border-radius: 50px; font-weight: bold;
            margin: 20px 0; border: 1px solid #a88734; display: inline-block;
        }

        .rating-hero { font-size: 72px; font-weight: 800; color: #f1c40f; margin: 0; }
        
        .review-card {
            background: #f9f9f9; padding: 15px; border-radius: 10px;
            margin-bottom: 15px; font-size: 14px; border: 1px solid #eee;
        }
        
        .stars { color: #f1c40f; font-size: 18px; }
        
        /* Form Styling */
        .post-box { background: #eef2f3; padding: 15px; border-radius: 10px; margin-top: auto; }
        textarea { width: 100%; height: 60px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; padding: 5px; box-sizing: border-box;}
    </style>
</head>
<body>

<div class="app-container">
    
    <aside class="sidebar-left">
        <h2>ðŸ“š Books</h2>
        <input type="text" id="search-input" class="search-box" placeholder="Search for books...">
        <button onclick="searchBooks()" style="width:100%; padding:10px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer;">Search</button>
        <div id="search-results" style="margin-top:20px;"></div>
    </aside>

    <main class="main-content">
        <div id="detail-view" style="display:none; max-width: 600px;">
            <img id="main-cover" src="" style="width: 200px; border-radius: 10px; shadow: 0 10px 20px rgba(0,0,0,0.2);">
            <h1 id="main-title">Book Title</h1>
            <p id="main-author" style="color: #666; font-weight: bold;"></p>
            <div id="amazon-container"></div>
            <p id="main-desc" style="line-height: 1.8; color: #444; text-align: justify;"></p>
        </div>
        <div id="empty-state">
            <h1>Select a book to start</h1>
        </div>
    </main>

    <aside class="sidebar-right">
        <h2>Community</h2>
        <div style="text-align: center; padding: 20px 0;">
            <div class="rating-hero" id="avg-rating">0.0</div>
            <p id="total-reviews" style="color:#777;">0 reviews</p>
        </div>
        
        <div id="reviews-container" style="flex: 1;">
            </div>

        <div class="post-box" id="post-box" style="display:none;">
            <h4>Write a Review</h4>
            <input type="number" id="rev-rating" min="1" max="5" placeholder="Rating (1-5)">
            <textarea id="rev-comment" placeholder="Your thoughts..."></textarea>
            <button onclick="submitReview()" style="width:100%; padding:10px; background:#27ae60; color:white; border:none; cursor:pointer; border-radius:5px;">Post</button>
        </div>
    </aside>
</div>



<script>
    let currentBookId = "";

    async function searchBooks() {
        const query = document.getElementById('search-input').value;
        const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${query}`);
        const data = await response.json();
        const resultsDiv = document.getElementById('search-results');
        resultsDiv.innerHTML = "";

        data.items.forEach(book => {
            const info = book.volumeInfo;
            const bId = book.id;
            const div = document.createElement('div');
            div.className = 'book-result';
            div.innerHTML = `
                <img src="${info.imageLinks?.smallThumbnail || ''}">
                <div>
                    <div style="font-weight:bold; font-size:14px;">${info.title}</div>
                    <div style="font-size:12px; color:#777;">${info.authors?.[0] || 'Unknown'}</div>
                </div>
            `;
            div.onclick = () => showBook(book);
            resultsDiv.appendChild(div);
        });
    }

    function showBook(book) {
        currentBookId = book.id;
        const info = book.volumeInfo;

        // Update Center
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('detail-view').style.display = 'block';
        document.getElementById('main-title').innerText = info.title;
        document.getElementById('main-author').innerText = `By ${info.authors?.join(', ') || 'Unknown Author'}`;
        document.getElementById('main-desc').innerText = info.description ? info.description.replace(/<[^>]*>/g, '') : "No description available.";
        document.getElementById('main-cover').src = info.imageLinks?.thumbnail || '';

        // Amazon Link
        const amzUrl = `https://www.amazon.com/s?k=${encodeURIComponent(info.title + " book")}`;
        document.getElementById('amazon-container').innerHTML = `<a href="${amzUrl}" target="_blank" class="amazon-btn">Buy on Amazon ðŸ›’</a>`;

        // Update Right Sidebar
        document.getElementById('post-box').style.display = 'block';
        loadForum(book.id);
    }

    async function loadForum(bId) {
        const response = await fetch(`http://localhost:5000/reviews/${bId}`);
        const data = await response.json();
        
        document.getElementById('avg-rating').innerText = data.averageRating || "0.0";
        document.getElementById('total-reviews').innerText = `${data.totalReviews || 0} Community Reviews`;

        const container = document.getElementById('reviews-container');
        container.innerHTML = "";
        
        if (data.reviews && data.reviews.length > 0) {
            data.reviews.forEach(r => {
                const div = document.createElement('div');
                div.className = 'review-card';
                div.innerHTML = `
                    <div style="font-weight:bold;">${r.username} <span class="stars">${'â˜…'.repeat(r.rating)}</span></div>
                    <div>${r.comment}</div>
                `;
                container.appendChild(div);
            });
        }
    }

    async function submitReview() {
        const rating = document.getElementById('rev-rating').value;
        const comment = document.getElementById('rev-comment').value;
        const token = localStorage.getItem('token'); // Get from login

        if(!token) return alert("Please Login!");

        const response = await fetch('http://localhost:5000/reviews', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ googleBookId: currentBookId, rating, comment })
        });

        if(response.ok) { loadForum(currentBookId); } else { alert("Error Posting."); }
    }
</script>

</body>
</html>